<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webview Initialization Fix - Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-controls {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .test-controls h3 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ready { background: #28a745; }
        .status-running { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-complete { background: #17a2b8; }
        
        .test-output {
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 6px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        
        .test-output.empty {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }
        
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        
        .result-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-card .label {
            color: #6c757d;
            font-size: 12px;
        }
        
        .value.success { color: #28a745; }
        .value.danger { color: #dc3545; }
        .value.warning { color: #ffc107; }
        .value.info { color: #17a2b8; }
        
        .test-suites {
            margin-top: 30px;
        }
        
        .suite-card {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .suite-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suite-header:hover {
            background: #e9ecef;
        }
        
        .suite-title {
            font-weight: 600;
            color: #495057;
        }
        
        .suite-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .suite-details {
            padding: 20px;
            background: white;
            display: none;
        }
        
        .suite-details.expanded {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .error-details {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            color: #721c24;
        }
        
        .error-details h5 {
            margin: 0 0 10px 0;
            color: #721c24;
        }
        
        .error-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .error-list li {
            padding: 5px 0;
            border-bottom: 1px solid #f5c6cb;
        }
        
        .error-list li:last-child {
            border-bottom: none;
        }
        
        .recommendations {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .recommendations h5 {
            margin: 0 0 10px 0;
            color: #0c5460;
        }
        
        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .recommendations li {
            margin-bottom: 5px;
            color: #0c5460;
        }
        
        .export-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .results-summary {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
            }
        }
        
        /* Console styling */
        .console-line {
            margin: 2px 0;
        }
        
        .console-error {
            color: #ff6b6b;
        }
        
        .console-warn {
            color: #ffd93d;
        }
        
        .console-success {
            color: #6bcf7f;
        }
        
        .console-info {
            color: #74c0fc;
        }
        
        /* Animation for running tests */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .running {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§ª Webview Initialization Fix</h1>
            <p>Comprehensive Test Suite for Requirements 5.1, 5.2, and 5.3</p>
        </div>
        
        <div class="content">
            <!-- Test Controls -->
            <div class="test-controls">
                <h3>Test Configuration & Controls</h3>
                
                <div class="control-group">
                    <button id="runAllTests" class="btn btn-success">
                        <span class="status-indicator status-ready"></span>
                        Run All Tests
                    </button>
                    
                    <button id="runReloadingTests" class="btn">Run Reloading Tests (5.1)</button>
                    <button id="runFunctionalityTests" class="btn">Run Functionality Tests (5.2)</button>
                    <button id="runErrorTests" class="btn">Run Error Handling Tests (5.3)</button>
                </div>
                
                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="runInParallel">
                        <label for="runInParallel">Run suites in parallel</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="stopOnFailure">
                        <label for="stopOnFailure">Stop on first failure</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="detailedReport" checked>
                        <label for="detailedReport">Generate detailed report</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="exportResults" checked>
                        <label for="exportResults">Export results</label>
                    </div>
                </div>
                
                <div class="control-group">
                    <button id="clearOutput" class="btn btn-warning">Clear Output</button>
                    <button id="stopTests" class="btn btn-danger" disabled>Stop Tests</button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <!-- Test Output Console -->
            <div class="test-output empty" id="testOutput">
                Click "Run All Tests" to start the comprehensive test suite...
            </div>
            
            <!-- Results Summary -->
            <div class="results-summary" id="resultsSummary" style="display: none;">
                <div class="result-card">
                    <h4>Total Tests</h4>
                    <div class="value info" id="totalTests">0</div>
                    <div class="label">Executed</div>
                </div>
                
                <div class="result-card">
                    <h4>Passed</h4>
                    <div class="value success" id="passedTests">0</div>
                    <div class="label">Successful</div>
                </div>
                
                <div class="result-card">
                    <h4>Failed</h4>
                    <div class="value danger" id="failedTests">0</div>
                    <div class="label">Issues Found</div>
                </div>
                
                <div class="result-card">
                    <h4>Success Rate</h4>
                    <div class="value" id="successRate">0%</div>
                    <div class="label">Overall</div>
                </div>
                
                <div class="result-card">
                    <h4>Duration</h4>
                    <div class="value info" id="testDuration">0s</div>
                    <div class="label">Total Time</div>
                </div>
            </div>
            
            <!-- Test Suites Details -->
            <div class="test-suites" id="testSuites" style="display: none;">
                <h3>Test Suite Results</h3>
                <!-- Suite cards will be populated dynamically -->
            </div>
            
            <!-- Recommendations -->
            <div class="recommendations" id="recommendations" style="display: none;">
                <h5>ðŸ’¡ Recommendations</h5>
                <ul id="recommendationsList">
                    <!-- Recommendations will be populated dynamically -->
                </ul>
            </div>
            
            <!-- Export Section -->
            <div class="export-section" id="exportSection" style="display: none;">
                <h3>Export Results</h3>
                <div class="export-buttons">
                    <button id="exportJSON" class="btn">Export as JSON</button>
                    <button id="exportCSV" class="btn">Export as CSV</button>
                    <button id="copyResults" class="btn">Copy to Clipboard</button>
                    <button id="saveLocal" class="btn">Save to LocalStorage</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load test dependencies (simulate webview environment) -->
    <script>
        // Mock VS Code API for testing
        window.acquireVsCodeApi = function() {
            return {
                postMessage: function(message) {
                    console.log('Mock VS Code API - Message sent:', message);
                }
            };
        };
        
        // Create mock canvas environment
        function createMockCanvasEnvironment() {
            // Create canvas container if it doesn't exist
            if (!document.getElementById('canvas-container')) {
                const container = document.createElement('div');
                container.id = 'canvas-container';
                container.style.display = 'none'; // Hidden for testing
                
                // Status bar
                const status = document.createElement('div');
                status.id = 'status';
                status.innerHTML = '<span>VSS Drawing Canvas - Ready</span><span class="connection-status disconnected" id="connection-status">Disconnected</span>';
                container.appendChild(status);
                
                // Toolbar
                const toolbar = document.createElement('div');
                toolbar.className = 'toolbar';
                toolbar.innerHTML = `
                    <button class="tool-button active" data-tool="pen" id="pen-tool">Pen</button>
                    <button class="tool-button" data-tool="eraser" id="eraser-tool">Eraser</button>
                    <button class="tool-button" id="clear-canvas">Clear</button>
                `;
                container.appendChild(toolbar);
                
                // Canvas
                const canvas = document.createElement('canvas');
                canvas.id = 'drawing-canvas';
                canvas.width = 800;
                canvas.height = 600;
                container.appendChild(canvas);
                
                // Error screen
                const errorScreen = document.createElement('div');
                errorScreen.id = 'error-screen';
                errorScreen.style.display = 'none';
                errorScreen.innerHTML = `
                    <div class="error-content">
                        <h2>Canvas Error</h2>
                        <div id="error-message" class="error-message"></div>
                        <div class="error-actions">
                            <button id="retry-button" class="retry-button">Retry</button>
                            <button id="report-button" class="report-button">Report Issue</button>
                        </div>
                        <details class="error-details">
                            <summary>Technical Details</summary>
                            <pre id="error-stack"></pre>
                        </details>
                    </div>
                `;
                container.appendChild(errorScreen);
                
                // Loading screen
                const loadingScreen = document.createElement('div');
                loadingScreen.id = 'loading-screen';
                loadingScreen.style.display = 'none';
                loadingScreen.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                    <div class="loading-text">
                        <h3>Loading Drawing Canvas...</h3>
                        <p id="loading-status">Initializing components...</p>
                    </div>
                `;
                container.appendChild(loadingScreen);
                
                document.body.appendChild(container);
            }
        }
        
        // Initialize mock environment
        createMockCanvasEnvironment();
    </script>

    <!-- Load test files -->
    <script src="webview-initialization-tests.js"></script>
    <script src="canvas-functionality-verification.js"></script>
    <script src="error-handling-tests.js"></script>
    <script src="webview-test-runner.js"></script>

    <!-- Main test page logic -->
    <script>
        class TestPageController {
            constructor() {
                this.isRunning = false;
                this.currentResults = null;
                this.setupEventListeners();
                this.setupConsoleCapture();
            }
            
            setupEventListeners() {
                // Test control buttons
                document.getElementById('runAllTests').addEventListener('click', () => this.runAllTests());
                document.getElementById('runReloadingTests').addEventListener('click', () => this.runSingleSuite('reloading'));
                document.getElementById('runFunctionalityTests').addEventListener('click', () => this.runSingleSuite('functionality'));
                document.getElementById('runErrorTests').addEventListener('click', () => this.runSingleSuite('error'));
                
                // Control buttons
                document.getElementById('clearOutput').addEventListener('click', () => this.clearOutput());
                document.getElementById('stopTests').addEventListener('click', () => this.stopTests());
                
                // Export buttons
                document.getElementById('exportJSON').addEventListener('click', () => this.exportJSON());
                document.getElementById('exportCSV').addEventListener('click', () => this.exportCSV());
                document.getElementById('copyResults').addEventListener('click', () => this.copyToClipboard());
                document.getElementById('saveLocal').addEventListener('click', () => this.saveToLocalStorage());
            }
            
            setupConsoleCapture() {
                const output = document.getElementById('testOutput');
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                console.log = (...args) => {
                    this.addToOutput(args.join(' '), 'info');
                    originalLog.apply(console, args);
                };
                
                console.error = (...args) => {
                    this.addToOutput(args.join(' '), 'error');
                    originalError.apply(console, args);
                };
                
                console.warn = (...args) => {
                    this.addToOutput(args.join(' '), 'warn');
                    originalWarn.apply(console, args);
                };
            }
            
            addToOutput(message, type = 'info') {
                const output = document.getElementById('testOutput');
                
                if (output.classList.contains('empty')) {
                    output.classList.remove('empty');
                    output.innerHTML = '';
                }
                
                const line = document.createElement('div');
                line.className = `console-line console-${type}`;
                line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }
            
            clearOutput() {
                const output = document.getElementById('testOutput');
                output.innerHTML = 'Output cleared...';
                output.classList.add('empty');
            }
            
            async runAllTests() {
                if (this.isRunning) return;
                
                this.setRunningState(true);
                this.clearOutput();
                this.showProgress(true);
                
                try {
                    const config = this.getTestConfig();
                    
                    if (typeof window.runAllWebviewTests === 'function') {
                        this.addToOutput('Starting comprehensive webview initialization fix tests...', 'info');
                        const results = await window.runAllWebviewTests(config);
                        this.handleTestResults(results);
                    } else {
                        throw new Error('Test runner not available. Please ensure all test files are loaded.');
                    }
                    
                } catch (error) {
                    this.addToOutput(`Test execution failed: ${error.message}`, 'error');
                    console.error('Test execution error:', error);
                } finally {
                    this.setRunningState(false);
                    this.showProgress(false);
                }
            }
            
            async runSingleSuite(suiteType) {
                if (this.isRunning) return;
                
                this.setRunningState(true);
                this.clearOutput();
                
                try {
                    let results;
                    
                    switch (suiteType) {
                        case 'reloading':
                            if (typeof WebviewReloadingTests !== 'undefined') {
                                const suite = new WebviewReloadingTests();
                                results = await suite.runAllTests();
                            }
                            break;
                        case 'functionality':
                            if (typeof CanvasFunctionalityVerification !== 'undefined') {
                                const suite = new CanvasFunctionalityVerification();
                                results = await suite.runFullVerification();
                            }
                            break;
                        case 'error':
                            if (typeof ErrorHandlingTestSuite !== 'undefined') {
                                const suite = new ErrorHandlingTestSuite();
                                results = await suite.runAllTests();
                            }
                            break;
                    }
                    
                    if (results) {
                        this.handleTestResults(results);
                    } else {
                        throw new Error(`Test suite ${suiteType} not available`);
                    }
                    
                } catch (error) {
                    this.addToOutput(`Test suite execution failed: ${error.message}`, 'error');
                } finally {
                    this.setRunningState(false);
                }
            }
            
            getTestConfig() {
                return {
                    runInParallel: document.getElementById('runInParallel').checked,
                    stopOnFirstFailure: document.getElementById('stopOnFailure').checked,
                    generateDetailedReport: document.getElementById('detailedReport').checked,
                    exportResults: document.getElementById('exportResults').checked
                };
            }
            
            setRunningState(running) {
                this.isRunning = running;
                
                const runButton = document.getElementById('runAllTests');
                const stopButton = document.getElementById('stopTests');
                const statusIndicator = runButton.querySelector('.status-indicator');
                
                if (running) {
                    runButton.disabled = true;
                    runButton.classList.add('running');
                    stopButton.disabled = false;
                    statusIndicator.className = 'status-indicator status-running';
                    runButton.innerHTML = '<span class="status-indicator status-running"></span>Running Tests...';
                } else {
                    runButton.disabled = false;
                    runButton.classList.remove('running');
                    stopButton.disabled = true;
                    statusIndicator.className = 'status-indicator status-complete';
                    runButton.innerHTML = '<span class="status-indicator status-ready"></span>Run All Tests';
                }
            }
            
            showProgress(show) {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.display = show ? 'block' : 'none';
                
                if (show) {
                    // Simulate progress
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += Math.random() * 10;
                        if (progress >= 100) {
                            progress = 100;
                            clearInterval(interval);
                        }
                        document.getElementById('progressFill').style.width = progress + '%';
                    }, 500);
                }
            }
            
            handleTestResults(results) {
                this.currentResults = results;
                this.updateResultsSummary(results);
                this.updateTestSuites(results);
                this.updateRecommendations(results);
                this.showExportSection(true);
            }
            
            updateResultsSummary(results) {
                const summary = results.summary || {};
                
                document.getElementById('totalTests').textContent = summary.totalTests || 0;
                document.getElementById('passedTests').textContent = summary.totalPassed || 0;
                document.getElementById('failedTests').textContent = summary.totalFailed || 0;
                document.getElementById('successRate').textContent = summary.overallSuccessRate || '0%';
                
                const duration = results.metadata?.duration || 0;
                document.getElementById('testDuration').textContent = (duration / 1000).toFixed(1) + 's';
                
                // Update success rate color
                const successRateElement = document.getElementById('successRate');
                const rate = parseFloat(summary.overallSuccessRate || '0');
                if (rate >= 90) {
                    successRateElement.className = 'value success';
                } else if (rate >= 70) {
                    successRateElement.className = 'value warning';
                } else {
                    successRateElement.className = 'value danger';
                }
                
                document.getElementById('resultsSummary').style.display = 'grid';
            }
            
            updateTestSuites(results) {
                const suitesContainer = document.getElementById('testSuites');
                const suiteResults = results.suiteResults || [];
                
                suitesContainer.innerHTML = '<h3>Test Suite Results</h3>';
                
                suiteResults.forEach((suite, index) => {
                    const suiteCard = this.createSuiteCard(suite, index);
                    suitesContainer.appendChild(suiteCard);
                });
                
                suitesContainer.style.display = 'block';
            }
            
            createSuiteCard(suite, index) {
                const card = document.createElement('div');
                card.className = 'suite-card';
                
                const successRate = typeof suite.successRate === 'string' ? 
                    suite.successRate : suite.successRate + '%';
                
                const statusClass = suite.failed === 0 ? 'success' : 'danger';
                const statusText = suite.failed === 0 ? 'Passed' : 'Failed';
                
                card.innerHTML = `
                    <div class="suite-header" onclick="this.parentElement.querySelector('.suite-details').classList.toggle('expanded')">
                        <div class="suite-title">${suite.suiteName}</div>
                        <div class="suite-status">
                            <span class="status-indicator status-${statusClass === 'success' ? 'ready' : 'error'}"></span>
                            <span>${statusText} (${successRate})</span>
                            <span>${suite.total} tests</span>
                        </div>
                    </div>
                    <div class="suite-details">
                        <p><strong>Tests:</strong> ${suite.total} | <strong>Passed:</strong> ${suite.passed} | <strong>Failed:</strong> ${suite.failed}</p>
                        <p><strong>Duration:</strong> ${(suite.duration || 0).toFixed(2)}ms</p>
                        
                        ${suite.errors && suite.errors.length > 0 ? `
                            <div class="error-details">
                                <h5>Errors (${suite.errors.length})</h5>
                                <ul class="error-list">
                                    ${suite.errors.slice(0, 5).map(error => `<li>${error}</li>`).join('')}
                                    ${suite.errors.length > 5 ? `<li>... and ${suite.errors.length - 5} more errors</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${suite.warnings && suite.warnings.length > 0 ? `
                            <div class="error-details" style="background: #fff3cd; border-color: #ffeaa7; color: #856404;">
                                <h5>Warnings (${suite.warnings.length})</h5>
                                <ul class="error-list">
                                    ${suite.warnings.slice(0, 3).map(warning => `<li>${warning}</li>`).join('')}
                                    ${suite.warnings.length > 3 ? `<li>... and ${suite.warnings.length - 3} more warnings</li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                return card;
            }
            
            updateRecommendations(results) {
                const recommendations = results.recommendations || [];
                
                if (recommendations.length > 0) {
                    const list = document.getElementById('recommendationsList');
                    list.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
                    document.getElementById('recommendations').style.display = 'block';
                } else {
                    document.getElementById('recommendations').style.display = 'none';
                }
            }
            
            showExportSection(show) {
                document.getElementById('exportSection').style.display = show ? 'block' : 'none';
            }
            
            stopTests() {
                // In a real implementation, this would cancel running tests
                this.addToOutput('Stop requested - tests will complete current suite...', 'warn');
            }
            
            exportJSON() {
                if (!this.currentResults) return;
                
                const dataStr = JSON.stringify(this.currentResults, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `webview-test-results-${new Date().toISOString().slice(0, 19)}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }
            
            exportCSV() {
                if (!this.currentResults) return;
                
                const suites = this.currentResults.suiteResults || [];
                const csvRows = [
                    ['Suite Name', 'Total Tests', 'Passed', 'Failed', 'Success Rate', 'Duration (ms)']
                ];
                
                suites.forEach(suite => {
                    csvRows.push([
                        suite.suiteName,
                        suite.total,
                        suite.passed,
                        suite.failed,
                        suite.successRate,
                        suite.duration || 0
                    ]);
                });
                
                const csvContent = csvRows.map(row => row.join(',')).join('\n');
                const dataBlob = new Blob([csvContent], {type: 'text/csv'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `webview-test-results-${new Date().toISOString().slice(0, 19)}.csv`;
                link.click();
                
                URL.revokeObjectURL(url);
            }
            
            async copyToClipboard() {
                if (!this.currentResults) return;
                
                const text = JSON.stringify(this.currentResults, null, 2);
                
                try {
                    await navigator.clipboard.writeText(text);
                    this.addToOutput('Test results copied to clipboard', 'success');
                } catch (err) {
                    this.addToOutput('Failed to copy to clipboard', 'error');
                }
            }
            
            saveToLocalStorage() {
                if (!this.currentResults) return;
                
                try {
                    localStorage.setItem('webview-test-results', JSON.stringify(this.currentResults));
                    this.addToOutput('Test results saved to localStorage', 'success');
                } catch (err) {
                    this.addToOutput('Failed to save to localStorage', 'error');
                }
            }
        }
        
        // Initialize the test page controller when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.testPageController = new TestPageController();
            
            // Add welcome message
            setTimeout(() => {
                console.log('ðŸŽ¯ Webview Initialization Fix Test Suite Ready');
                console.log('ðŸ“‹ This test suite validates the fixes for:');
                console.log('   â€¢ Task 5.1: Webview reloading scenarios');
                console.log('   â€¢ Task 5.2: Canvas functionality integrity');
                console.log('   â€¢ Task 5.3: Error handling and recovery');
                console.log('ðŸš€ Click "Run All Tests" to begin comprehensive testing');
            }, 500);
        });
    </script>
</body>
</html>