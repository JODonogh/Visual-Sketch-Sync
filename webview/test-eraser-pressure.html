<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Eraser Functionality and Pressure Sensitivity</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #cccccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .test-pass {
            background: #1e4d3e;
            border: 1px solid #28a745;
            color: #d4edda;
        }
        
        .test-fail {
            background: #4d1e1e;
            border: 1px solid #dc3545;
            color: #f8d7da;
        }
        
        .test-info {
            background: #1e3a4d;
            border: 1px solid #17a2b8;
            color: #d1ecf1;
        }
        
        .canvas-container {
            width: 100%;
            height: 400px;
            position: relative;
            background: white;
            border: 1px solid #555;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .test-toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            border-radius: 6px;
            padding: 6px;
            display: flex;
            gap: 6px;
            z-index: 100;
            height: 30px;
            align-items: center;
        }
        
        .tool-button {
            background: #3c3c3c;
            border: none;
            color: #cccccc;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
        }
        
        .tool-button:hover {
            background: #4c4c4c;
        }
        
        .tool-button.active {
            background: #007acc;
        }
        
        .measurement-display {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .pressure-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 10px;
            z-index: 200;
        }
        
        .pressure-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .pressure-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.1s ease, background-color 0.1s ease;
        }
        
        .eraser-cursor {
            position: absolute;
            border: 2px dashed #ff0000;
            border-radius: 50%;
            pointer-events: none;
            display: none;
        }
        
        .settings-panel {
            position: absolute;
            top: 50px;
            right: 10px;
            width: 220px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            z-index: 150;
        }
        
        .pressure-test-area {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .pressure-canvas {
            background: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test: Eraser Functionality and Pressure Sensitivity</h1>
        <p>Testing Requirements: 5.1, 5.2, 5.3, 5.4, 6.1, 6.2, 6.3, 6.4</p>
        
        <!-- Test 1: Eraser Functionality -->
        <div class="test-section">
            <h2>Test 1: Eraser Functionality (Requirements 5.1, 5.2, 5.3, 5.4)</h2>
            <p>Test eraser tool operation and tool switching behavior</p>
            
            <div class="canvas-container">
                <canvas id="eraser-canvas" width="800" height="350" style="background: white;"></canvas>
                <div class="test-toolbar">
                    <button id="eraser-pen" class="tool-button active" onclick="selectEraserTool('pen')">‚úèÔ∏è Pen</button>
                    <button id="eraser-rectangle" class="tool-button" onclick="selectEraserTool('rectangle')">‚¨ú Rectangle</button>
                    <button id="eraser-eraser" class="tool-button" onclick="selectEraserTool('eraser')">üßΩ Eraser</button>
                    <button id="eraser-clear" class="tool-button" onclick="clearEraserCanvas()">üóëÔ∏è Clear</button>
                </div>
                
                <div class="eraser-cursor" id="eraser-cursor"></div>
                
                <div class="settings-panel">
                    <h4>Eraser Settings</h4>
                    <div>
                        <label>Eraser Size: <span id="eraser-size-value">20</span>px</label><br>
                        <input type="range" id="eraser-size" min="5" max="100" value="20" 
                               onchange="updateEraserSize()" style="width: 100%;">
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" id="eraser-feedback" checked onchange="toggleEraserFeedback()">
                            Visual Feedback
                        </label>
                    </div>
                </div>
            </div>
            
            <div>
                <button onclick="drawTestContent()">‚úèÔ∏è Draw Test Content</button>
                <button onclick="testEraserOperation()">üßΩ Test Eraser Operation</button>
                <button onclick="testToolSwitchingFromEraser()">üîÑ Test Tool Switching</button>
                <button onclick="validateEraserFunctionality()">‚úÖ Validate Eraser</button>
            </div>
            
            <div class="measurement-display">
                <div>Current Tool: <span id="current-eraser-tool">pen</span></div>
                <div>Composite Operation: <span id="composite-operation">source-over</span></div>
                <div>Eraser Size: <span id="current-eraser-size">20</span>px</div>
                <div>Tool Switches: <span id="eraser-tool-switches">0</span></div>
            </div>
            
            <div id="eraser-test-result" class="test-result"></div>
        </div>
        
        <!-- Test 2: Pressure Sensitivity Detection -->
        <div class="test-section">
            <h2>Test 2: Pressure Sensitivity Detection (Requirements 6.1, 6.2)</h2>
            <p>Test pressure detection for stylus and mouse input</p>
            
            <div class="pressure-test-area">
                <div>
                    <h4>Stylus Pressure Test</h4>
                    <canvas id="stylus-canvas" class="pressure-canvas" width="300" height="200"></canvas>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        Use a pressure-sensitive stylus to draw
                    </div>
                </div>
                
                <div>
                    <h4>Mouse Speed Simulation</h4>
                    <canvas id="mouse-canvas" class="pressure-canvas" width="300" height="200"></canvas>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        Draw with mouse - speed affects thickness
                    </div>
                </div>
            </div>
            
            <div class="pressure-indicator">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: #cccccc; font-size: 12px; font-weight: 500;">Pressure</span>
                    <span id="pressure-value" style="color: #cccccc; font-size: 12px;">50%</span>
                </div>
                <div class="pressure-bar">
                    <div class="pressure-fill" id="pressure-fill" style="width: 50%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                    <span id="device-label" style="color: #999; font-size: 10px;">Mouse (Speed)</span>
                    <span style="color: #999; font-size: 10px;">Real-time</span>
                </div>
            </div>
            
            <div>
                <button onclick="testPressureDetection()">üì± Test Pressure Detection</button>
                <button onclick="simulateMousePressure()">üñ±Ô∏è Simulate Mouse Pressure</button>
                <button onclick="validatePressureMapping()">‚úÖ Validate Pressure Mapping</button>
            </div>
            
            <div class="measurement-display">
                <div>Input Device: <span id="input-device">Mouse</span></div>
                <div>Pressure Support: <span id="pressure-support">Simulated</span></div>
                <div>Current Pressure: <span id="current-pressure">0.5</span></div>
                <div>Stroke Width Range: <span id="stroke-width-range">2-20px</span></div>
            </div>
            
            <div id="pressure-detection-result" class="test-result"></div>
        </div>
        
        <!-- Test 3: Pressure Sensitivity Settings -->
        <div class="test-section">
            <h2>Test 3: Pressure Sensitivity Settings (Requirements 6.3, 6.4)</h2>
            <p>Test pressure sensitivity controls and real-time feedback</p>
            
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <canvas id="pressure-settings-canvas" width="400" height="300" style="background: white; border: 1px solid #555;"></canvas>
                </div>
                
                <div style="width: 250px;">
                    <div class="settings-panel" style="position: static; width: auto;">
                        <h4>Pressure Settings</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label>
                                <input type="checkbox" id="pressure-enabled" checked onchange="togglePressureSensitivity()">
                                Enable Pressure Sensitivity
                            </label>
                        </div>
                        
                        <div id="pressure-controls" style="margin-left: 20px;">
                            <div style="margin-bottom: 10px;">
                                <label>Min Pressure: <span id="min-pressure-value">10</span>%</label><br>
                                <input type="range" id="min-pressure" min="1" max="50" value="10" 
                                       onchange="updateMinPressure()" style="width: 100%;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label>Max Pressure: <span id="max-pressure-value">100</span>%</label><br>
                                <input type="range" id="max-pressure" min="50" max="100" value="100" 
                                       onchange="updateMaxPressure()" style="width: 100%;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label>
                                    <input type="checkbox" id="mouse-speed-simulation" checked onchange="toggleMouseSpeedSimulation()">
                                    Mouse Speed Simulation
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label>
                                    <input type="checkbox" id="real-time-feedback" checked onchange="toggleRealtimeFeedback()">
                                    Real-time Feedback
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div>
                <button onclick="testPressureSettings()">‚öôÔ∏è Test Pressure Settings</button>
                <button onclick="testRealtimeFeedback()">üìä Test Real-time Feedback</button>
                <button onclick="validatePressureControls()">‚úÖ Validate Controls</button>
            </div>
            
            <div class="measurement-display">
                <div>Pressure Enabled: <span id="pressure-enabled-status">Yes</span></div>
                <div>Min Pressure: <span id="current-min-pressure">10%</span></div>
                <div>Max Pressure: <span id="current-max-pressure">100%</span></div>
                <div>Mouse Simulation: <span id="mouse-simulation-status">Enabled</span></div>
                <div>Feedback: <span id="feedback-status">Enabled</span></div>
            </div>
            
            <div id="pressure-settings-result" class="test-result"></div>
        </div>
        
        <!-- Overall Test Summary -->
        <div class="test-section">
            <h2>üìä Test Summary</h2>
            <div id="test-summary">
                <div class="measurement-display">
                    <div>Tests Run: <span id="tests-run">0</span></div>
                    <div>Tests Passed: <span id="tests-passed">0</span></div>
                    <div>Tests Failed: <span id="tests-failed">0</span></div>
                    <div>Success Rate: <span id="success-rate">0%</span></div>
                </div>
            </div>
            
            <button onclick="runAllEraserPressureTests()">üöÄ Run All Tests</button>
            <button onclick="generateEraserPressureReport()">üìã Generate Report</button>
        </div>
    </div>

    <script>
        // Test state management
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            results: []
        };
        
        // Tool and pressure state
        let currentTool = 'pen';
        let toolSwitches = 0;
        let pressureSettings = {
            enabled: true,
            minPressure: 0.1,
            maxPressure: 1.0,
            mouseSpeedSimulation: true,
            realtimeFeedback: true
        };
        
        let currentPressure = 0.5;
        let eraserSize = 20;
        let isDrawing = false;
        let lastMousePos = { x: 0, y: 0 };
        let lastMouseTime = 0;
        
        // Test 1: Eraser Functionality
        function selectEraserTool(tool) {
            // Update visual state
            document.querySelectorAll('#eraser-pen, #eraser-rectangle, #eraser-eraser').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`eraser-${tool}`).classList.add('active');
            
            currentTool = tool;
            toolSwitches++;
            
            document.getElementById('current-eraser-tool').textContent = tool;
            document.getElementById('eraser-tool-switches').textContent = toolSwitches;
            
            // Update canvas composite operation
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            
            if (tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                document.getElementById('composite-operation').textContent = 'destination-out';
                showEraserCursor(true);
            } else {
                ctx.globalCompositeOperation = 'source-over';
                document.getElementById('composite-operation').textContent = 'source-over';
                showEraserCursor(false);
            }
        }
        
        function showEraserCursor(show) {
            const cursor = document.getElementById('eraser-cursor');
            cursor.style.display = show ? 'block' : 'none';
            
            if (show) {
                cursor.style.width = eraserSize + 'px';
                cursor.style.height = eraserSize + 'px';
            }
        }
        
        function updateEraserSize() {
            eraserSize = parseInt(document.getElementById('eraser-size').value);
            document.getElementById('eraser-size-value').textContent = eraserSize;
            document.getElementById('current-eraser-size').textContent = eraserSize;
            
            const cursor = document.getElementById('eraser-cursor');
            cursor.style.width = eraserSize + 'px';
            cursor.style.height = eraserSize + 'px';
        }
        
        function toggleEraserFeedback() {
            const enabled = document.getElementById('eraser-feedback').checked;
            showEraserCursor(enabled && currentTool === 'eraser');
        }
        
        function drawTestContent() {
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            
            // Ensure we're in drawing mode
            ctx.globalCompositeOperation = 'source-over';
            
            // Draw some test shapes
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.strokeRect(50, 50, 100, 80);
            
            ctx.strokeStyle = '#00ff00';
            ctx.beginPath();
            ctx.arc(250, 90, 40, 0, 2 * Math.PI);
            ctx.stroke();
            
            ctx.strokeStyle = '#0000ff';
            ctx.beginPath();
            ctx.moveTo(350, 50);
            ctx.lineTo(450, 130);
            ctx.stroke();
            
            // Draw some pen strokes
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(100, 200);
            ctx.quadraticCurveTo(200, 150, 300, 200);
            ctx.stroke();
        }
        
        function testEraserOperation() {
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            
            // Switch to eraser
            selectEraserTool('eraser');
            
            // Simulate eraser strokes
            ctx.lineWidth = eraserSize;
            ctx.lineCap = 'round';
            
            // Erase part of the rectangle
            ctx.beginPath();
            ctx.moveTo(75, 75);
            ctx.lineTo(125, 105);
            ctx.stroke();
            
            // Erase part of the circle
            ctx.beginPath();
            ctx.moveTo(230, 90);
            ctx.lineTo(270, 90);
            ctx.stroke();
        }
        
        function testToolSwitchingFromEraser() {
            // Start with eraser
            selectEraserTool('eraser');
            
            // Switch to pen
            selectEraserTool('pen');
            
            // Try to draw (should work normally)
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(500, 100);
            ctx.lineTo(600, 150);
            ctx.stroke();
        }
        
        function validateEraserFunctionality() {
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            
            let passed = true;
            let messages = [];
            
            // Check if composite operation is correctly set
            const currentComposite = ctx.globalCompositeOperation;
            if (currentTool === 'eraser' && currentComposite !== 'destination-out') {
                passed = false;
                messages.push('Eraser composite operation not set correctly');
            }
            
            if (currentTool !== 'eraser' && currentComposite !== 'source-over') {
                passed = false;
                messages.push('Non-eraser composite operation not reset correctly');
            }
            
            // Check if tool switching worked
            if (toolSwitches < 3) {
                passed = false;
                messages.push('Insufficient tool switching tests');
            }
            
            const message = passed 
                ? `‚úÖ Eraser functionality works correctly (${toolSwitches} tool switches tested)`
                : `‚ùå Eraser functionality issues: ${messages.join(', ')}`;
            
            document.getElementById('eraser-test-result').className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            document.getElementById('eraser-test-result').textContent = message;
            
            recordTestResult('Eraser Functionality', passed, message);
        }
        
        function clearEraserCanvas() {
            const canvas = document.getElementById('eraser-canvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Test 2: Pressure Detection
        function setupPressureCanvases() {
            const stylusCanvas = document.getElementById('stylus-canvas');
            const mouseCanvas = document.getElementById('mouse-canvas');
            
            // Add event listeners for pressure testing
            [stylusCanvas, mouseCanvas].forEach((canvas, index) => {
                const ctx = canvas.getContext('2d');
                let drawing = false;
                
                canvas.addEventListener('pointerdown', (e) => {
                    drawing = true;
                    const pressure = e.pressure || 0.5;
                    updatePressureDisplay(pressure, e.pointerType);
                    
                    ctx.beginPath();
                    ctx.moveTo(e.offsetX, e.offsetY);
                });
                
                canvas.addEventListener('pointermove', (e) => {
                    if (!drawing) return;
                    
                    let pressure = e.pressure || 0.5;
                    
                    // Simulate mouse pressure based on speed for mouse canvas
                    if (index === 1 && e.pointerType === 'mouse') {
                        const now = Date.now();
                        const speed = Math.sqrt(
                            Math.pow(e.offsetX - lastMousePos.x, 2) + 
                            Math.pow(e.offsetY - lastMousePos.y, 2)
                        ) / Math.max(now - lastMouseTime, 1);
                        
                        pressure = Math.max(0.1, Math.min(1.0, 1.0 - (speed / 10)));
                        lastMousePos = { x: e.offsetX, y: e.offsetY };
                        lastMouseTime = now;
                    }
                    
                    updatePressureDisplay(pressure, e.pointerType);
                    
                    // Draw with pressure-sensitive width
                    const minWidth = 1;
                    const maxWidth = 20;
                    const width = minWidth + (maxWidth - minWidth) * pressure;
                    
                    ctx.lineWidth = width;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = `rgba(0, 0, 0, ${0.5 + pressure * 0.5})`;
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(e.offsetX, e.offsetY);
                });
                
                canvas.addEventListener('pointerup', () => {
                    drawing = false;
                });
            });
        }
        
        function updatePressureDisplay(pressure, pointerType) {
            currentPressure = pressure;
            const percentage = Math.round(pressure * 100);
            
            document.getElementById('pressure-value').textContent = percentage + '%';
            document.getElementById('pressure-fill').style.width = percentage + '%';
            document.getElementById('current-pressure').textContent = pressure.toFixed(2);
            
            // Update device label
            const deviceLabel = pointerType === 'pen' ? 'Stylus' : 'Mouse (Speed)';
            document.getElementById('device-label').textContent = deviceLabel;
            document.getElementById('input-device').textContent = pointerType === 'pen' ? 'Stylus' : 'Mouse';
            document.getElementById('pressure-support').textContent = pointerType === 'pen' ? 'Native' : 'Simulated';
            
            // Update pressure bar color based on pressure
            const pressureFill = document.getElementById('pressure-fill');
            if (pressure < 0.3) {
                pressureFill.style.background = '#ffc107';
            } else if (pressure < 0.7) {
                pressureFill.style.background = '#28a745';
            } else {
                pressureFill.style.background = '#dc3545';
            }
        }
        
        function testPressureDetection() {
            // Simulate pressure detection test
            let passed = true;
            let messages = [];
            
            // Check if pressure events are supported
            const hasPointerEvents = 'PointerEvent' in window;
            if (!hasPointerEvents) {
                passed = false;
                messages.push('Pointer events not supported');
            }
            
            // Test pressure range
            const minPressure = pressureSettings.minPressure;
            const maxPressure = pressureSettings.maxPressure;
            
            if (minPressure >= maxPressure) {
                passed = false;
                messages.push('Invalid pressure range');
            }
            
            const message = passed 
                ? `‚úÖ Pressure detection works correctly (range: ${minPressure}-${maxPressure})`
                : `‚ùå Pressure detection issues: ${messages.join(', ')}`;
            
            document.getElementById('pressure-detection-result').className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            document.getElementById('pressure-detection-result').textContent = message;
            
            recordTestResult('Pressure Detection', passed, message);
        }
        
        function simulateMousePressure() {
            // Simulate mouse pressure based on speed
            const canvas = document.getElementById('mouse-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw strokes with varying simulated pressure
            const pressures = [0.2, 0.5, 0.8, 1.0];
            
            pressures.forEach((pressure, index) => {
                const y = 50 + index * 40;
                const width = 2 + pressure * 18;
                
                ctx.lineWidth = width;
                ctx.strokeStyle = `rgba(0, 0, 0, ${0.5 + pressure * 0.5})`;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(20, y);
                ctx.lineTo(280, y);
                ctx.stroke();
                
                updatePressureDisplay(pressure, 'mouse');
            });
        }
        
        function validatePressureMapping() {
            let passed = true;
            let messages = [];
            
            // Check pressure to width mapping
            const minWidth = 2;
            const maxWidth = 20;
            const testPressure = 0.5;
            const expectedWidth = minWidth + (maxWidth - minWidth) * testPressure;
            const actualWidth = 2 + testPressure * 18; // From simulation
            
            if (Math.abs(expectedWidth - actualWidth) > 1) {
                passed = false;
                messages.push('Pressure to width mapping incorrect');
            }
            
            // Check pressure range
            const range = `${minWidth}-${maxWidth}px`;
            document.getElementById('stroke-width-range').textContent = range;
            
            const message = passed 
                ? `‚úÖ Pressure mapping works correctly (${range})`
                : `‚ùå Pressure mapping issues: ${messages.join(', ')}`;
            
            document.getElementById('pressure-detection-result').className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            document.getElementById('pressure-detection-result').textContent = message;
            
            recordTestResult('Pressure Mapping', passed, message);
        }
        
        // Test 3: Pressure Settings
        function togglePressureSensitivity() {
            const enabled = document.getElementById('pressure-enabled').checked;
            pressureSettings.enabled = enabled;
            
            document.getElementById('pressure-enabled-status').textContent = enabled ? 'Yes' : 'No';
            document.getElementById('pressure-controls').style.opacity = enabled ? '1' : '0.5';
        }
        
        function updateMinPressure() {
            const value = parseInt(document.getElementById('min-pressure').value);
            pressureSettings.minPressure = value / 100;
            
            document.getElementById('min-pressure-value').textContent = value;
            document.getElementById('current-min-pressure').textContent = value + '%';
        }
        
        function updateMaxPressure() {
            const value = parseInt(document.getElementById('max-pressure').value);
            pressureSettings.maxPressure = value / 100;
            
            document.getElementById('max-pressure-value').textContent = value;
            document.getElementById('current-max-pressure').textContent = value + '%';
        }
        
        function toggleMouseSpeedSimulation() {
            const enabled = document.getElementById('mouse-speed-simulation').checked;
            pressureSettings.mouseSpeedSimulation = enabled;
            
            document.getElementById('mouse-simulation-status').textContent = enabled ? 'Enabled' : 'Disabled';
        }
        
        function toggleRealtimeFeedback() {
            const enabled = document.getElementById('real-time-feedback').checked;
            pressureSettings.realtimeFeedback = enabled;
            
            document.getElementById('feedback-status').textContent = enabled ? 'Enabled' : 'Disabled';
            
            const indicator = document.querySelector('.pressure-indicator');
            indicator.style.display = enabled ? 'block' : 'none';
        }
        
        function testPressureSettings() {
            // Test all pressure settings
            const canvas = document.getElementById('pressure-settings-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw with different pressure settings
            const minPressure = pressureSettings.minPressure;
            const maxPressure = pressureSettings.maxPressure;
            
            for (let i = 0; i < 5; i++) {
                const pressure = minPressure + (maxPressure - minPressure) * (i / 4);
                const y = 50 + i * 50;
                const width = 2 + pressure * 18;
                
                ctx.lineWidth = width;
                ctx.strokeStyle = `rgba(0, 0, 0, ${0.5 + pressure * 0.5})`;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(20, y);
                ctx.lineTo(380, y);
                ctx.stroke();
            }
        }
        
        function testRealtimeFeedback() {
            // Simulate real-time pressure changes
            const pressures = [0.1, 0.3, 0.5, 0.7, 0.9, 1.0, 0.7, 0.4, 0.1];
            let index = 0;
            
            const interval = setInterval(() => {
                if (index >= pressures.length) {
                    clearInterval(interval);
                    return;
                }
                
                updatePressureDisplay(pressures[index], 'pen');
                index++;
            }, 200);
        }
        
        function validatePressureControls() {
            let passed = true;
            let messages = [];
            
            // Check if all settings are properly configured
            if (pressureSettings.minPressure >= pressureSettings.maxPressure) {
                passed = false;
                messages.push('Invalid pressure range');
            }
            
            if (!pressureSettings.enabled && pressureSettings.realtimeFeedback) {
                // This is actually OK - feedback can be enabled even if pressure is disabled
            }
            
            // Check if controls are responsive
            const minSlider = document.getElementById('min-pressure');
            const maxSlider = document.getElementById('max-pressure');
            
            if (!minSlider || !maxSlider) {
                passed = false;
                messages.push('Pressure controls not found');
            }
            
            const message = passed 
                ? `‚úÖ Pressure controls work correctly (${Math.round(pressureSettings.minPressure * 100)}%-${Math.round(pressureSettings.maxPressure * 100)}%)`
                : `‚ùå Pressure control issues: ${messages.join(', ')}`;
            
            document.getElementById('pressure-settings-result').className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            document.getElementById('pressure-settings-result').textContent = message;
            
            recordTestResult('Pressure Controls', passed, message);
        }
        
        // Test result management
        function recordTestResult(testName, passed, message) {
            testResults.total++;
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            testResults.results.push({
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toISOString()
            });
            
            updateTestSummary();
        }
        
        function updateTestSummary() {
            document.getElementById('tests-run').textContent = testResults.total;
            document.getElementById('tests-passed').textContent = testResults.passed;
            document.getElementById('tests-failed').textContent = testResults.failed;
            
            const successRate = testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }
        
        function runAllEraserPressureTests() {
            // Reset test results
            testResults = { total: 0, passed: 0, failed: 0, results: [] };
            
            // Run all tests in sequence
            setTimeout(() => {
                drawTestContent();
                testEraserOperation();
                testToolSwitchingFromEraser();
                validateEraserFunctionality();
            }, 100);
            
            setTimeout(() => testPressureDetection(), 800);
            setTimeout(() => simulateMousePressure(), 1200);
            setTimeout(() => validatePressureMapping(), 1600);
            setTimeout(() => testPressureSettings(), 2000);
            setTimeout(() => testRealtimeFeedback(), 2400);
            setTimeout(() => validatePressureControls(), 2800);
        }
        
        function generateEraserPressureReport() {
            const report = {
                testSuite: 'Eraser Functionality and Pressure Sensitivity',
                timestamp: new Date().toISOString(),
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    successRate: testResults.total > 0 ? (testResults.passed / testResults.total * 100).toFixed(1) + '%' : '0%'
                },
                requirements: [
                    '5.1 - Eraser removes parts without affecting tool switching',
                    '5.2 - Switching from eraser to other tools works correctly',
                    '5.3 - Canvas composite operation properly reset',
                    '5.4 - Eraser provides visual feedback',
                    '6.1 - Stroke width varies based on pressure input',
                    '6.2 - Light/heavy pressure creates thin/thick strokes',
                    '6.3 - Mouse pressure simulation or graceful disable',
                    '6.4 - Pressure settings take effect immediately'
                ],
                results: testResults.results
            };
            
            console.log('Eraser & Pressure Test Report:', JSON.stringify(report, null, 2));
            
            alert(`Eraser & Pressure Test Report Generated!\n\nTotal Tests: ${report.summary.total}\nPassed: ${report.summary.passed}\nFailed: ${report.summary.failed}\nSuccess Rate: ${report.summary.successRate}\n\nCheck console for detailed report.`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTestSummary();
            setupPressureCanvases();
            
            // Set up eraser canvas mouse tracking for cursor
            const eraserCanvas = document.getElementById('eraser-canvas');
            const eraserCursor = document.getElementById('eraser-cursor');
            
            eraserCanvas.addEventListener('mousemove', (e) => {
                if (currentTool === 'eraser') {
                    const rect = eraserCanvas.getBoundingClientRect();
                    eraserCursor.style.left = (rect.left + e.offsetX - eraserSize/2) + 'px';
                    eraserCursor.style.top = (rect.top + e.offsetY - eraserSize/2) + 'px';
                }
            });
            
            // Auto-run some basic tests
            setTimeout(() => {
                drawTestContent();
                testPressureDetection();
            }, 500);
        });
    </script>
</body>
</html>